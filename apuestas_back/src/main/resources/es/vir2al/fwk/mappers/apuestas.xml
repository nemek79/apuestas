<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="es.vir2al.apuestas.app.repositories.ApuestasDAO">

 	<resultMap type="ApuestaVO" id="apuesta" autoMapping="true">
		<id property="id" column="id" />
		<result property="fechaAlta" column="fecha_alta" />
		<result property="fechaEvento" column="fecha_evento" />
        <result property="fechaAlta" column="fecha_alta" />
        <result property="tipster.id" column="tipster_id" />
        <result property="tipster.descripcion" column="tipster_descripcion" />
        <result property="tipster.comentario" column="tipster_comentario" />
        <result property="tipoApuesta.id" column="tipoapuesta_id" />
        <result property="tipoApuesta.descripcion" column="tipoapuesta_descripcion" />
        <result property="tipoApuesta.comentario" column="tipoapuesta_comentario" /> 
        <result property="live" column="live" />
        <result property="reto" column="reto" />
		<result property="modificado" column="modificado" />
        <result property="deporte.id" column="deporte_id" />
        <result property="deporte.descripcion" column="deporte_descripcion" />
        <result property="deporte.comentario" column="deporte_comentario" />  
        <result property="evento" column="evento" />
        <result property="apuesta" column="apuesta" />    
        <result property="stake" column="stake" />
        <result property="cuota" column="cuota" />
        <result property="cantidadApostada" column="cantidadApostada" />
        <result property="bruto" column="bruto" />    
        <result property="estadoApuesta.id" column="estadoapuesta_id" />
        <result property="estadoApuesta.descripcion" column="estadoapuesta_descripcion" />
        <result property="estadoApuesta.comentario" column="estadoapuesta_comentario" />    
        <result property="encuentro" column="encuentro" /> 
        <result property="comentario" column="comentario" /> 
    </resultMap>   

	<select id="getApuestaById" resultMap="apuesta"
		parameterType="map">
		<include refid="apuestasSelect" />
		<include refid="apuestasFrom" />
		<where>
			<include refid="apuestasJoin" />
			<include refid="apuestasByIdFilter" />
		</where>
	</select>

	<select id="getApuestas" resultMap="apuesta"
		parameterType="map">
		<include refid="apuestasSelect" />
		<include refid="apuestasFrom" />
		<where>
			<include refid="apuestasJoin" />
			<include refid="apuestasFilter" />
		</where>
		<include refid="apuestasSort" />
	</select>
	
	<select id="getApuestasCount" resultType="Integer">
		<include refid="countSelect" />
		<include refid="apuestasFrom" />
		<where>
			<include refid="apuestasJoin" />
			<include refid="apuestasFilter" />
		</where>
	</select>

    <insert id="createApuesta" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_apuestas(id,fecha_alta,fecha_evento,tipster_id,
								tipo_id,live,reto,deporte_id,evento,apuesta,stake,cuota,cantidad_apostada,
                                bruto,estado_id,encuentro,comentario,modificado)
        VALUES (null,#{criteria.fechaAlta},#{criteria.fechaEvento},#{criteria.tipster.id},#{criteria.tipoApuesta.id},#{criteria.live},#{criteria.reto}
                ,#{criteria.deporte.id},#{criteria.evento},#{criteria.apuesta},#{criteria.stake},#{criteria.cuota},#{criteria.cantidadApostada},#{criteria.bruto}
                ,#{criteria.estadoApuesta.id},#{criteria.encuentro},#{criteria.comentario},#{criteria.modificado})
    </insert>

	<update id="updateApuesta">
		UPDATE t_apuestas
		   SET fecha_evento = #{criteria.fechaEvento},
		       tipster_id = #{criteria.tipster.id},
			   tipo_id = #{criteria.tipoApuesta.id},
			   deporte_id = #{criteria.deporte.id},
			   live = #{criteria.live},
			   reto = #{criteria.reto},
			   evento = #{criteria.evento},
			   apuesta = #{criteria.apuesta},
			   stake = #{criteria.stake},
			   cuota = #{criteria.cuota},
			   cantidad_apostada = #{criteria.cantidadApostada},
			   bruto = #{criteria.bruto},
			   estado_id = #{criteria.estadoApuesta.id},
			   encuentro = #{criteria.encuentro},
			   comentario = #{criteria.comentario}
		 WHERE id = #{id}
	</update>

    <sql id="apuestasSelect">
        SELECT ta.id,ta.fecha_alta,ta.fecha_evento,
				ta.tipster_id,tt.descripcion tipster_descripcion,tt.comentario tipster_comentario,
			    ta.tipo_id tipoapuesta_id, tta.descripcion tipoapuesta_descripcion, tta.comentario tipoapuesta_comentario,
			    ta.live,ta.reto,
				ta.deporte_id deporte_id, td.descripcion deporte_descripcion, td.comentario deporte_comentario,
				ta.evento,ta.apuesta,ta.stake,ta.cuota,ta.cantidad_apostada,ta.bruto,
				ta.estado_id estadoapuesta_id, tea.descripcion estadoapuesta_descripcion, tea.comentario estadoapuesta_comentario,
				ta.encuentro,ta.comentario,ta.modificado
    </sql>

 	<sql id="countSelect">
		SELECT COUNT(1)
	</sql>   

	<sql id="apuestasFrom">
		FROM t_apuestas ta,
			 t_tipsters tt,
			 t_tipos_apuesta tta,
			 t_deportes td,
			 t_estados_apuesta tea
	</sql>

	<sql id="apuestasJoin">
		AND ta.tipster_id = tt.id
		AND ta.tipo_id = tta.id
		AND ta.deporte_id = td.id
		AND ta.estado_id = tea.id
	</sql>

	<sql id="apuestasByIdFilter">
		AND ta.id = #{id}
	</sql>

	<sql id="apuestasFilter">
		<if test="criteria['tipsterId'] != null">
			AND ta.tipster_id = #{criteria.tipsterId}
		</if>
		<if test="criteria['deporteId'] != null">
			AND ta.deporte_id = #{criteria.deporteId}
		</if>
		<if test="criteria['estadoId'] != null">
			AND ta.estado_id = #{criteria.estadoId}
		</if>
		<if test="criteria['tipoId'] != null">
			AND ta.tipo_id = #{criteria.tipoId}
		</if>
		<if test="criteria['reto'] != null and criteria['reto'] == true">
			AND ta.reto = 1
		</if>
		<if test="criteria['live'] != null and criteria['live'] == true">
			AND ta.live = 1
		</if>
		<if test="criteria['reto'] != null and riteria['reto'] == false">
			AND ta.reto = 0
		</if>
		<if test="criteria['live'] != null and criteria['live'] == false">
			AND ta.live = 0
		</if>
		<if test="criteria['fechaIni'] != null and criteria['fechaFin'] != null">
			AND ta.fecha_evento BETWEEN  DATE_FORMAT(#{criteria.fechaIni},'%Y-%m-%d') AND DATE_FORMAT(#{criteria.fechaFin},'%Y-%m-%d')
		</if>
		<if test="criteria['fechaIni'] != null and !criteria['fechaFin'] == null">
			AND ta.fecha_evento =  DATE_FORMAT(#{criteria.fechaIni},'%Y-%m-%d')	
		</if>
		<if test="criteria['stake'] != null">
			AND ta.stake = #{criteria.stake}
		</if>
		<if test="criteria['evento'] != null">
			<bind name="evento" value="'%' + criteria['evento'] + '%'" />
			AND ta.evento LIKE #{evento}
		</if>
	</sql>

	<sql id="apuestasSort">
		<choose>
			<when test="navigation.sortField != null">
				ORDER BY ${navigation.sortField}
				<if
					test="navigation.sortField != null and navigation.sortOrder == -1">
					DESC
				</if>
			</when>
			<otherwise>
				<if
					test="navigation.sortFieldDefault != null and navigation.sortFieldDefault.size()>0">
					ORDER BY
					<foreach collection="navigation.sortFieldDefault"
						separator="," index="id" item="field">
						${field}
						<if
							test="navigation.sortOrderDefault != null and navigation.sortOrderDefault.size() > idx and navigation.sortOrderDefault[id] == -1 ">
							DESC
						</if>
					</foreach>
				</if>
				<if
					test="navigation.sortFieldDefault == null or navigation.sortFieldDefault.size() == 0">
					ORDER BY ta.id
				</if>
			</otherwise>
		</choose>
	</sql>

</mapper>